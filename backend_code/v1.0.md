# JDWX Backend Ubuntu 部署指南 v1.0

本文档提供在全新 Ubuntu 系统上从零开始部署 JDWX Backend 服务的详细步骤。

## 目录

- [系统要求](#系统要求)
- [初始系统配置](#初始系统配置)
- [安装必要软件](#安装必要软件)
- [项目部署](#项目部署)
- [数据库配置](#数据库配置)
- [服务配置](#服务配置)
- [Nginx 配置](#nginx-配置)
- [安全加固](#安全加固)
- [监控和维护](#监控和维护)
- [故障排查](#故障排查)
- [API 接口说明](#api-接口说明)

## 系统要求

### 最低配置
- **操作系统**: Ubuntu 20.04 LTS 或更高版本（推荐 Ubuntu 22.04 LTS）
- **CPU**: 2 核心
- **内存**: 2GB RAM（推荐 4GB）
- **磁盘**: 20GB 可用空间
- **网络**: 稳定的互联网连接

### 软件要求
- **Node.js**: 18.x LTS（推荐）
- **MySQL**: 8.0（推荐）
- **Nginx**: 最新稳定版
- **PM2**: 最新版本（用于进程管理）

## 初始系统配置

### 1. 连接到服务器

如果您使用的是云服务器，请使用 SSH 连接到服务器：

```bash
# 在本地终端执行
ssh username@your-server-ip

# 例如
ssh root@192.168.1.100
```

### 2. 更新系统软件包

首次登录后，首先更新系统：

```bash
# 更新软件包列表
sudo apt update

# 升级已安装的软件包
sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim nano
```

### 3. 创建系统用户账号

创建以下3个系统用户账号，供团队成员使用：

```bash
# 创建 lht 用户（主要操作账号）
sudo adduser lht
# 设置密码：ddac#afCRT%3
# 其他信息可以按Enter跳过

# 将 lht 添加到 sudo 组
sudo usermod -aG sudo lht

# 创建 zwb 用户
sudo adduser zwb
# 设置密码：ddac#afCRT%3
# 其他信息可以按Enter跳过

# 将 zwb 添加到 sudo 组
sudo usermod -aG sudo zwb

# 创建 hwd 用户
sudo adduser hwd
# 设置密码：ddac#afCRT%3
# 其他信息可以按Enter跳过

# 将 hwd 添加到 sudo 组
sudo usermod -aG sudo hwd

# 验证用户创建成功
id lht
id zwb
id hwd
```

**重要提示：**
- 所有系统用户密码统一为：`ddac#afCRT%3`
- 所有用户都已添加到sudo组，具有管理员权限
- `lht` 是主要操作账号
- 建议使用 `lht` 账号进行后续操作：`su - lht`

## 安装必要软件

### 1. 安装 Node.js 18.x LTS

#### 方法一：使用 NodeSource（推荐）

```bash
# 安装 Node.js 18.x LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# 安装 Node.js
sudo apt-get install -y nodejs

# 验证安装
node --version
# 应该显示 v18.x.x

npm --version
# 应该显示 9.x.x 或更高
```

如果遇到 curl 未安装的错误，先安装 curl：

```bash
sudo apt install -y curl
```

#### 方法二：使用 NVM（可选）

如果您需要管理多个 Node.js 版本，可以使用 NVM：

```bash
# 安装 NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载 shell 配置
source ~/.bashrc

# 安装 Node.js 18
nvm install 18
nvm use 18
nvm alias default 18

# 验证安装
node --version
npm --version
```

### 2. 安装 MySQL 8.0

```bash
# 安装 MySQL 服务器
sudo apt install -y mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql

# 设置 MySQL 开机自启
sudo systemctl enable mysql

# 检查 MySQL 服务状态
sudo systemctl status mysql
```

#### 配置 MySQL 安全设置

```bash
# 运行安全配置脚本
sudo mysql_secure_installation
```

按照提示进行配置：
- 设置 root 密码强度验证级别（建议选择 2）
- **设置 root 密码为：`ddac#afROOT%3`**（注意：xxxx部分使用大写ROOT）
- 移除匿名用户（选择 Y）
- 禁止 root 远程登录（选择 Y，如果只需要本地访问）
- 移除测试数据库（选择 Y）
- 重新加载权限表（选择 Y）

#### 验证 MySQL 安装

```bash
# 登录 MySQL（使用密码：ddac#afROOT%3）
sudo mysql -u root -p

# 在 MySQL 中执行以下命令验证
SHOW DATABASES;
EXIT;
```

### 3. 安装 Nginx

```bash
# 安装 Nginx
sudo apt install -y nginx

# 启动 Nginx 服务
sudo systemctl start nginx

# 设置 Nginx 开机自启
sudo systemctl enable nginx

# 检查 Nginx 服务状态
sudo systemctl status nginx
```

#### 验证 Nginx 安装

在浏览器中访问服务器的 IP 地址，应该能看到 Nginx 的欢迎页面。

或者使用命令行：

```bash
curl http://localhost
```

### 4. 安装 PM2

```bash
# 全局安装 PM2
sudo npm install -g pm2

# 验证安装
pm2 --version
```

#### 配置 PM2 开机自启

```bash
# 生成 systemd 启动脚本
pm2 startup systemd

# 命令会输出类似以下内容，请复制并执行：
# sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u username --hp /home/username
```

按照输出的命令执行（需要 root 权限）。

## 项目部署

### 1. 创建应用目录

```bash
# 创建应用目录
sudo mkdir -p /opt/jdwx_backend_server

# 设置目录所有者（将 username 替换为您的用户名）
sudo chown -R $USER:$USER /opt/jdwx_backend_server

# 进入目录
cd /opt/jdwx_backend_server
```

### 2. 上传项目文件

将项目文件上传到服务器，可以使用以下方法：

#### 方法一：使用 Git（推荐）

```bash
# 克隆项目（替换为您的仓库地址）
git clone <your-repository-url> .

# 如果没有 Git，先安装
# sudo apt install -y git
```

#### 方法二：使用 SCP（从本地 Windows/Mac 上传）

在本地终端执行：

```bash
# Windows PowerShell 或 Mac/Linux 终端
scp -r ./jdwx_backend_server username@your-server-ip:/opt/
```

#### 方法三：使用 SFTP 客户端

使用 FileZilla、WinSCP 等工具，通过 SFTP 协议上传项目文件夹到 `/opt/jdwx_backend_server`。

### 3. 安装项目依赖

```bash
# 确保在项目目录
cd /opt/jdwx_backend_server

# 安装生产环境依赖
npm install --production
```

如果安装过程中遇到权限问题：

```bash
# 检查 node_modules 目录权限
ls -la node_modules

# 如果需要，修复权限
sudo chown -R $USER:$USER node_modules
```

### 4. 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑环境变量文件
nano .env
```

**重要配置项说明：**

```env
# 数据库配置（必须修改）
DB_HOST=localhost
DB_USER=jdwx_backend_user01
DB_PASSWORD=ddac#afJDWX_BACKEND_USER01%3
DB_NAME=jdwx_db
DB_PORT=3306
DB_CONN_LIMIT=10

# 服务器配置
PORT=3000
HOST=0.0.0.0

# JWT 密钥（必须修改为强密码，至少32字符）
# 可以使用以下命令生成随机密钥：
# node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=your-very-strong-secret-key-minimum-32-characters-long

# JWT 过期时间
JWT_EXPIRES=7d

# 密码加密轮数
BCRYPT_ROUNDS=10

# CORS 配置（多个域名用逗号分隔，留空则允许所有来源）
CORS_ORIGINS=

# 速率限制（每分钟最大请求数）
RATE_LIMIT_MAX=45

# 文件上传大小限制（字节，默认10MB）
MAX_FILE_SIZE=10485760

# 环境模式
NODE_ENV=production

# 日志级别
LOG_LEVEL=INFO
```

**生成 JWT_SECRET 的方法：**

```bash
# 在服务器上执行
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

将输出的字符串复制到 `.env` 文件的 `JWT_SECRET` 中。

保存文件：按 `Ctrl + O`，然后按 `Enter`，最后按 `Ctrl + X` 退出。

### 5. 创建必要的目录

```bash
# 创建日志和上传目录
mkdir -p logs uploads

# 设置目录权限
chmod 775 logs uploads
```

## 数据库配置

### 密码格式说明

所有账号密码遵循统一格式：

| 账号类型 | 账号名 | 密码格式 | 示例密码 |
|---------|--------|---------|---------|
| MySQL root | root | ddac#afROOT%3 | ddac#afROOT%3 |
| 数据库用户 | jdwx_backend_user01 | ddac#af账号名%3 | ddac#afJDWX_BACKEND_USER01%3 |
| 数据库用户 | lht | ddac#af账号名%3 | ddac#afLHT%3 |
| 数据库用户 | zwb | ddac#af账号名%3 | ddac#afZWB%3 |
| 数据库用户 | hwd | ddac#af账号名%3 | ddac#afHWD%3 |
| Ubuntu系统用户 | lht/zwb/hwd | ddac#afCRT%3 | ddac#afCRT%3 |

**注意：**
- MySQL root密码中的xxxx部分使用大写：ROOT
- 数据库用户密码中的xxxx部分使用大写账号名
- 所有Ubuntu系统用户密码统一为：ddac#afCRT%3

### 1. 创建数据库和用户

```bash
# 登录 MySQL（使用 root 密码）
sudo mysql -u root -p
```

在 MySQL 命令行中执行以下 SQL 语句（使用统一密码格式）：

```sql
-- 创建数据库
CREATE DATABASE jdwx_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建后端服务数据库用户（密码格式：ddac#af账号名%3，账号名大写）
CREATE USER 'jdwx_backend_user01'@'localhost' IDENTIFIED BY 'ddac#afJDWX_BACKEND_USER01%3';

-- 授权（授予该用户对 jdwx_db 数据库的所有权限）
GRANT ALL PRIVILEGES ON jdwx_db.* TO 'jdwx_backend_user01'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 查看用户（验证创建成功）
SELECT user, host FROM mysql.user WHERE user = 'jdwx_backend_user01';

-- 退出 MySQL
EXIT;
```

**重要提示：**
- 后端服务数据库用户密码为：`ddac#afJDWX_BACKEND_USER01%3`（账号名部分大写）
- 将这个密码更新到 `.env` 文件中的 `DB_PASSWORD`

### 1.1 创建额外的数据库用户账号

除了后端服务使用的 `jdwx_backend_user01` 账号外，还需要创建以下数据库账号供团队成员使用：
- `lht` - 主要操作账号（您主要使用的账号）
- `zwb` - 第二个数据库账号
- `hwd` - 第三个数据库账号

这些账号与 `jdwx_backend_user01` 具有相同的权限（对 `jdwx_db` 数据库的所有权限）。

**注意：** 后端服务始终使用 `.env` 文件中配置的 `jdwx_backend_user01` 账号，这些额外账号仅用于团队成员手动操作数据库。

在 MySQL 命令行中执行以下 SQL 语句（使用统一密码格式）：

```sql
-- 创建 lht 账号（主要操作账号，允许远程连接，密码格式：ddac#af账号名%3，账号名大写）
CREATE USER 'lht'@'%' IDENTIFIED BY 'ddac#afLHT%3';
GRANT ALL PRIVILEGES ON jdwx_db.* TO 'lht'@'%';

-- 创建 zwb 账号（允许远程连接，密码格式：ddac#af账号名%3，账号名大写）
CREATE USER 'zwb'@'%' IDENTIFIED BY 'ddac#afZWB%3';
GRANT ALL PRIVILEGES ON jdwx_db.* TO 'zwb'@'%';

-- 创建 hwd 账号（允许远程连接，密码格式：ddac#af账号名%3，账号名大写）
CREATE USER 'hwd'@'%' IDENTIFIED BY 'ddac#afHWD%3';
GRANT ALL PRIVILEGES ON jdwx_db.* TO 'hwd'@'%';

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证所有用户已创建
SELECT user, host FROM mysql.user WHERE user IN ('jdwx_backend_user01', 'lht', 'zwb', 'hwd');

-- 退出 MySQL
EXIT;
```

**重要提示：**
- 所有数据库用户密码遵循统一格式：`ddac#af账号名%3`（账号名大写）
- `jdwx_backend_user01` 使用 `'localhost'`，仅限服务器本地连接，用于后端服务
- `lht`、`zwb`、`hwd` 使用 `'%'`，允许远程连接，用于外部工具（如 Navicat）连接
- `lht` 账号是主要操作账号，密码为：`ddac#afLHT%3`
- `zwb` 账号密码为：`ddac#afZWB%3`
- `hwd` 账号密码为：`ddac#afHWD%3`
- 这些账号仅用于数据库操作，不影响后端服务的运行（后端服务使用 `jdwx_backend_user01`）
- 如果需要远程连接，还需要配置 MySQL 允许远程连接和防火墙（见下文）

### 1.2 配置 MySQL 允许远程连接

默认情况下，MySQL 只允许本地连接。要允许远程连接（供 lht、zwb、hwd 账号使用），需要修改 MySQL 配置：

```bash
# 编辑 MySQL 配置文件
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# 找到 bind-address 行，将其注释或修改为：
# bind-address = 0.0.0.0
# 或者
# bind-address = ::

# 保存文件（Ctrl+O，Enter，Ctrl+X）
```

**注意：** 如果 MySQL 配置文件位置不同，可以使用以下命令查找：

```bash
# 查找 MySQL 配置文件
sudo find /etc -name "mysqld.cnf" 2>/dev/null
# 或者
sudo find /etc -name "my.cnf" 2>/dev/null
```

修改配置文件后，重启 MySQL 服务：

```bash
# 重启 MySQL 服务
sudo systemctl restart mysql

# 验证 MySQL 是否监听所有接口
sudo netstat -tlnp | grep 3306
# 应该显示 0.0.0.0:3306 或 :::3306，表示监听所有网络接口

# 检查 MySQL 服务状态
sudo systemctl status mysql
```

**安全提示：**
- 允许远程连接会增加安全风险，请确保：
  - 使用强密码
  - 配置防火墙限制访问（见"安全加固"章节）
  - 如果可能，建议使用 SSH 隧道或 VPN 连接

### 2. 更新 .env 文件中的数据库密码

```bash
# 编辑 .env 文件
nano /opt/jdwx_backend_server/.env

# 找到 DB_PASSWORD 行，更新为：
DB_PASSWORD=ddac#afJDWX_BACKEND_USER01%3
```

**注意：** 确保密码格式正确，账号名部分为大写：`JDWX_BACKEND_USER01`

### 3. 测试数据库连接

#### 3.1 测试后端服务账号

```bash
# 使用后端服务账号测试连接
mysql -u jdwx_backend_user01 -p jdwx_db

# 输入密码：ddac#afJDWX_BACKEND_USER01%3
# 如果成功进入 MySQL 命令行，说明连接正常
# 输入 EXIT; 退出
```

#### 3.2 测试其他数据库账号

```bash
# 测试 lht 账号（主要操作账号）
mysql -u lht -p jdwx_db
# 输入密码：ddac#afLHT%3

# 测试 zwb 账号
mysql -u zwb -p jdwx_db
# 输入密码：ddac#afZWB%3

# 测试 hwd 账号
mysql -u hwd -p jdwx_db
# 输入密码：ddac#afHWD%3

# 每个账号都应该能成功连接并访问 jdwx_db 数据库
# 输入 EXIT; 退出每个连接
```

**验证账号权限：**

在 MySQL 命令行中，可以执行以下命令验证账号权限：

```sql
-- 查看当前用户的权限
SHOW GRANTS;

-- 查看数据库
SHOW DATABASES;

-- 使用数据库
USE jdwx_db;

-- 查看表
SHOW TABLES;

-- 退出
EXIT;
```

#### 3.3 从外部使用 Navicat 连接

在外部电脑上使用 Navicat 连接数据库：

**前提条件：**
- MySQL 已配置允许远程连接（见"1.2 配置 MySQL 允许远程连接"）
- 服务器防火墙已开放 3306 端口（见"安全加固"章节）
- 云服务商的安全组已允许 3306 端口（如使用云服务器）

**连接步骤：**

1. **打开 Navicat，创建新连接**
   - 打开 Navicat Premium 或 Navicat for MySQL
   - 点击"连接" → "MySQL"
   - 或点击工具栏的"新建连接"按钮

2. **配置连接参数**
   - **连接名**：自定义（如：JDWX Server - lht）
   - **主机名或IP地址**：`your-server-ip`（云服务器的公网IP地址）
   - **端口**：`3306`
   - **用户名**：`lht`、`zwb` 或 `hwd`（根据需要使用）
   - **密码**：对应的密码
     - lht: `ddac#afLHT%3`
     - zwb: `ddac#afZWB%3`
     - hwd: `ddac#afHWD%3`

3. **高级设置（可选）**
   - 点击"高级"标签
   - 可以设置连接超时、字符集等
   - 默认设置通常即可

4. **测试连接**
   - 点击"测试连接"按钮
   - 如果显示"连接成功"，说明配置正确
   - 如果失败，检查错误信息并参考故障排查部分

5. **保存并连接**
   - 点击"确定"保存连接配置
   - 双击连接名称连接到数据库

6. **连接后操作**
   - 在左侧数据库列表中，展开服务器
   - 选择 `jdwx_db` 数据库
   - 可以开始查看和操作数据库表

**连接参数示例：**

```
连接名：JDWX Server - lht
主机：123.456.789.0（示例IP，替换为实际服务器IP）
端口：3306
用户名：lht
密码：ddac#afLHT%3
```

**注意事项：**
- 确保云服务器的安全组/防火墙已开放 3306 端口
- 确保 MySQL 已配置允许远程连接（bind-address = 0.0.0.0）
- 如果连接失败，检查：
  - 服务器防火墙是否开放 3306 端口：`sudo ufw status`
  - MySQL 是否监听所有接口：`sudo netstat -tlnp | grep 3306`
  - 云服务商的安全组是否允许 3306 端口（阿里云、腾讯云等需要在控制台配置）
  - 网络是否可达：在外部电脑使用 `telnet your-server-ip 3306` 测试
- 建议使用强密码，并定期更换
- 如果可能，建议使用 SSH 隧道连接（更安全）

### 4. 创建数据库表结构

在创建数据库和用户后，需要创建以下三个表来支持应用功能。

#### 4.1 表结构说明

项目需要以下三个数据库表：

1. **jdwx_users** - 用户表：存储用户账号信息
2. **jdwx_orders** - 订单表：存储订单信息
3. **jdwx_order_logs** - 订单日志表：记录订单操作历史

#### 4.2 创建表 SQL 语句

登录 MySQL 并执行以下 SQL 语句创建表结构：

```bash
# 登录 MySQL
mysql -u jdwx_backend_user01 -p jdwx_db
```

在 MySQL 命令行中执行以下 SQL：

```sql
-- 使用数据库
USE jdwx_db;

-- 1. 创建用户表
CREATE TABLE IF NOT EXISTS jdwx_users (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  password VARCHAR(255) NOT NULL COMMENT '密码（bcrypt加密）',
  role ENUM('user', 'staff', 'admin') NOT NULL DEFAULT 'user' COMMENT '角色：user-用户，staff-员工，admin-管理员',
  phone VARCHAR(20) DEFAULT NULL UNIQUE COMMENT '手机号',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_username (username),
  INDEX idx_phone (phone),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 2. 创建订单表
CREATE TABLE IF NOT EXISTS jdwx_orders (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '订单ID',
  order_no VARCHAR(20) NOT NULL UNIQUE COMMENT '订单号',
  user_id INT NOT NULL COMMENT '用户ID',
  location VARCHAR(255) NOT NULL COMMENT '服务地址',
  phone VARCHAR(20) DEFAULT NULL COMMENT '联系电话',
  description TEXT NOT NULL COMMENT '订单描述',
  image_url VARCHAR(500) DEFAULT NULL COMMENT '图片URL',
  status ENUM('pending', 'doing', 'done', 'cancelled') NOT NULL DEFAULT 'pending' COMMENT '订单状态：pending-待处理，doing-处理中，done-已完成，cancelled-已取消',
  staff_id INT DEFAULT NULL COMMENT '接单员工ID',
  rating TINYINT DEFAULT NULL COMMENT '评分（1-5）',
  rating_comment TEXT DEFAULT NULL COMMENT '评价内容',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_user_id (user_id),
  INDEX idx_staff_id (staff_id),
  INDEX idx_status (status),
  INDEX idx_order_no (order_no),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (user_id) REFERENCES jdwx_users(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (staff_id) REFERENCES jdwx_users(id) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单表';

-- 3. 创建订单日志表
CREATE TABLE IF NOT EXISTS jdwx_order_logs (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID',
  order_id INT NOT NULL COMMENT '订单ID',
  staff_id INT DEFAULT NULL COMMENT '操作员工ID',
  action VARCHAR(20) NOT NULL COMMENT '操作类型：create-创建，take-接单，finish-完成，cancel-取消，update-更新，rate-评价',
  message TEXT DEFAULT NULL COMMENT '日志消息',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_order_id (order_id),
  INDEX idx_staff_id (staff_id),
  INDEX idx_action (action),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (order_id) REFERENCES jdwx_orders(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (staff_id) REFERENCES jdwx_users(id) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单日志表';

-- 验证表创建成功
SHOW TABLES;

-- 查看表结构
DESCRIBE jdwx_users;
DESCRIBE jdwx_orders;
DESCRIBE jdwx_order_logs;

-- 退出 MySQL
EXIT;
```

#### 4.3 表结构说明

**jdwx_users（用户表）**

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 用户ID | 主键，自增 |
| username | VARCHAR(50) | 用户名 | 非空，唯一 |
| password | VARCHAR(255) | 密码 | 非空，bcrypt加密存储 |
| role | ENUM | 角色 | 非空，默认'user'，可选值：user/staff/admin |
| phone | VARCHAR(20) | 手机号 | 可选，唯一 |
| created_at | DATETIME | 创建时间 | 非空，默认当前时间 |

**jdwx_orders（订单表）**

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 订单ID | 主键，自增 |
| order_no | VARCHAR(20) | 订单号 | 非空，唯一 |
| user_id | INT | 用户ID | 非空，外键关联 jdwx_users.id |
| location | VARCHAR(255) | 服务地址 | 非空 |
| phone | VARCHAR(20) | 联系电话 | 可选 |
| description | TEXT | 订单描述 | 非空 |
| image_url | VARCHAR(500) | 图片URL | 可选 |
| status | ENUM | 订单状态 | 非空，默认'pending'，可选值：pending/doing/done/cancelled |
| staff_id | INT | 接单员工ID | 可选，外键关联 jdwx_users.id |
| rating | TINYINT | 评分 | 可选，1-5 |
| rating_comment | TEXT | 评价内容 | 可选 |
| created_at | DATETIME | 创建时间 | 非空，默认当前时间 |
| updated_at | DATETIME | 更新时间 | 非空，自动更新 |

**jdwx_order_logs（订单日志表）**

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 日志ID | 主键，自增 |
| order_id | INT | 订单ID | 非空，外键关联 jdwx_orders.id |
| staff_id | INT | 操作员工ID | 可选，外键关联 jdwx_users.id |
| action | VARCHAR(20) | 操作类型 | 非空，可选值：create/take/finish/cancel/update/rate |
| message | TEXT | 日志消息 | 可选 |
| created_at | DATETIME | 创建时间 | 非空，默认当前时间 |

#### 4.4 表关系说明

- **jdwx_users** 与 **jdwx_orders**：一对多关系（一个用户可以有多个订单）
- **jdwx_users** 与 **jdwx_orders**（staff_id）：多对一关系（一个员工可以处理多个订单）
- **jdwx_orders** 与 **jdwx_order_logs**：一对多关系（一个订单可以有多条日志记录）
- **jdwx_users** 与 **jdwx_order_logs**：多对一关系（一个员工可以产生多条日志）

**外键约束说明：**
- `jdwx_orders.user_id` → `jdwx_users.id`：删除用户时限制删除（RESTRICT），更新时级联（CASCADE）
- `jdwx_orders.staff_id` → `jdwx_users.id`：删除员工时设置为 NULL（SET NULL），更新时级联（CASCADE）
- `jdwx_order_logs.order_id` → `jdwx_orders.id`：删除订单时级联删除日志（CASCADE），更新时级联（CASCADE）
- `jdwx_order_logs.staff_id` → `jdwx_users.id`：删除员工时设置为 NULL（SET NULL），更新时级联（CASCADE）

### 5. 导入数据库结构（如果有 SQL 文件）

如果项目中有数据库结构 SQL 文件，也可以直接导入：

```bash
cd /opt/jdwx_backend_server

# 导入 SQL 文件（如果有）
mysql -u jdwx_backend_user01 -p jdwx_db < database/schema.sql
```

**注意：** 如果使用 SQL 文件导入，请确保 SQL 文件包含上述三个表的创建语句。

## 服务配置

### 1. 测试服务启动

在配置 PM2 之前，先手动测试服务是否能正常启动：

```bash
cd /opt/jdwx_backend_server

# 手动启动服务（测试）
NODE_ENV=production node src/server.js
```

如果看到类似以下输出，说明启动成功：

```
[INFO] 环境变量验证通过
[INFO] 数据库连接测试成功
[INFO] 服务器运行在 http://0.0.0.0:3000 (PID: xxxxx)
[INFO] 环境: production
[INFO] JWT_SECRET 验证通过
```

按 `Ctrl + C` 停止服务。

### 2. 使用 PM2 启动服务

```bash
cd /opt/jdwx_backend_server

# 使用 PM2 配置文件启动
pm2 start ecosystem.config.js --env production

# 查看 PM2 状态
pm2 status

# 查看日志
pm2 logs jdwx-backend

# 保存 PM2 配置（确保开机自启）
pm2 save
```

### 3. 验证服务运行

```bash
# 检查端口是否监听
sudo netstat -tlnp | grep 3000

# 或使用 ss 命令
sudo ss -tlnp | grep 3000

# 测试健康检查接口
curl http://localhost:3000/api/health
```

应该返回类似以下内容：

```json
{
  "success": true,
  "uptime": 123.456,
  "timestamp": "2024-12-20T10:00:00.000Z",
  "database": "connected"
}
```

### 4. 配置 Systemd 服务（可选但推荐）

使用 systemd 可以更好地管理系统服务：

```bash
# 复制服务文件
sudo cp /opt/jdwx_backend_server/deploy/jdwx-backend.service /etc/systemd/system/

# 编辑服务文件（如果需要修改路径或用户）
sudo nano /etc/systemd/system/jdwx-backend.service
```

检查并修改以下内容：
- `User` 和 `Group`：设置为运行服务的用户（如 `www-data` 或您的用户名）
- `WorkingDirectory`：确保路径正确（`/opt/jdwx_backend_server`）
- `EnvironmentFile`：确保路径正确

```bash
# 重新加载 systemd
sudo systemctl daemon-reload

# 启用服务（开机自启）
sudo systemctl enable jdwx-backend.service

# 启动服务
sudo systemctl start jdwx-backend.service

# 检查服务状态
sudo systemctl status jdwx-backend.service
```

## Nginx 配置

### 1. 创建 Nginx 配置文件

```bash
# 复制配置示例
sudo cp /opt/jdwx_backend_server/deploy/nginx.conf.example /etc/nginx/sites-available/jdwx-backend

# 编辑配置文件
sudo nano /etc/nginx/sites-available/jdwx-backend
```

**重要修改项：**

```nginx
# 修改 server_name（将 your-domain.com 替换为您的域名或IP）
server_name your-domain.com;  # 或 server_name 192.168.1.100;

# 如果使用 IP 访问，可以设置为：
# server_name _;
```

### 2. 启用配置

```bash
# 创建软链接到 sites-enabled
sudo ln -s /etc/nginx/sites-available/jdwx-backend /etc/nginx/sites-enabled/

# 测试 Nginx 配置
sudo nginx -t

# 如果测试通过，重新加载 Nginx
sudo systemctl reload nginx
```

### 3. 验证 Nginx 配置

```bash
# 检查 Nginx 状态
sudo systemctl status nginx

# 测试 API 接口（通过 Nginx）
curl http://your-domain.com/api/health
# 或
curl http://your-server-ip/api/health
```

### 4. 配置 HTTPS（推荐，生产环境必须）

#### 使用 Let's Encrypt 免费 SSL 证书

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取 SSL 证书（将 your-domain.com 替换为您的域名）
sudo certbot --nginx -d your-domain.com

# 按照提示操作：
# 1. 输入邮箱地址
# 2. 同意服务条款
# 3. 选择是否共享邮箱（可选）
# 4. Certbot 会自动配置 Nginx
```

**注意：** Let's Encrypt 需要域名和有效的 DNS 解析。如果只有 IP 地址，可以跳过此步骤或使用自签名证书。

#### 测试证书自动续期

```bash
# 测试自动续期
sudo certbot renew --dry-run
```

证书会自动续期，无需手动操作。

## 安全加固

### 1. 配置防火墙（UFW）

```bash
# 检查 UFW 状态
sudo ufw status

# 允许 SSH（重要：先允许 SSH，避免被锁在外面）
sudo ufw allow 22/tcp

# 允许 HTTP
sudo ufw allow 80/tcp

# 允许 HTTPS
sudo ufw allow 443/tcp

# 允许 MySQL 远程连接（3306端口）
# 选项1：允许所有IP访问（简单但不安全）
sudo ufw allow 3306/tcp

# 选项2：只允许特定IP访问（更安全，推荐）
# sudo ufw allow from 192.168.1.100 to any port 3306
# 将 192.168.1.100 替换为实际的外部IP地址
# 可以添加多个IP：
# sudo ufw allow from 192.168.1.100 to any port 3306
# sudo ufw allow from 192.168.1.101 to any port 3306

# 启用防火墙
sudo ufw enable

# 再次检查状态
sudo ufw status
```

**MySQL 远程连接安全建议：**
- 如果可能，建议使用 SSH 隧道或 VPN 连接，而不是直接暴露 MySQL 端口
- 如果必须直接暴露，建议限制为特定IP地址（使用选项2）
- 定期检查 MySQL 访问日志：`sudo tail -f /var/log/mysql/error.log`
- 确保使用强密码，并定期更换
- 考虑使用云服务商的安全组功能，进一步限制访问

### 2. 设置文件权限

```bash
cd /opt/jdwx_backend_server

# 设置 .env 文件权限（只有所有者可读写）
chmod 600 .env

# 设置目录权限
chmod 755 src
chmod 775 logs uploads

# 如果使用 www-data 用户运行服务
sudo chown -R www-data:www-data /opt/jdwx_backend_server
sudo chmod 600 /opt/jdwx_backend_server/.env
```

### 3. 安全建议

- **定期更新系统**：
  ```bash
  sudo apt update && sudo apt upgrade -y
  ```

- **使用强密码**：数据库密码、JWT_SECRET 等都应使用强密码

- **定期备份**：设置自动备份数据库和重要文件

- **监控日志**：定期检查应用日志和系统日志

- **限制 SSH 访问**：考虑使用密钥认证而非密码认证

## 监控和维护

### 1. 查看日志

#### PM2 日志

```bash
# 查看所有日志
pm2 logs jdwx-backend

# 只查看错误日志
pm2 logs jdwx-backend --err

# 只查看输出日志
pm2 logs jdwx-backend --out

# 清空日志
pm2 flush
```

#### Systemd 日志

```bash
# 查看服务日志
sudo journalctl -u jdwx-backend.service -f

# 查看最近 50 条日志
sudo journalctl -u jdwx-backend.service -n 50

# 查看今天的日志
sudo journalctl -u jdwx-backend.service --since today
```

#### 应用日志

```bash
# 查看应用日志文件
tail -f /opt/jdwx_backend_server/logs/*.log

# 查看特定日期的日志
cat /opt/jdwx_backend_server/logs/2024-12-20.log
```

#### Nginx 日志

```bash
# 访问日志
sudo tail -f /var/log/nginx/jdwx-backend-access.log

# 错误日志
sudo tail -f /var/log/nginx/jdwx-backend-error.log
```

### 2. 监控服务状态

```bash
# PM2 状态
pm2 status

# PM2 监控面板（实时监控）
pm2 monit

# Systemd 状态
sudo systemctl status jdwx-backend.service

# 检查端口
sudo netstat -tlnp | grep 3000
# 或
sudo ss -tlnp | grep 3000
```

### 3. 性能监控

```bash
# 安装 htop（更友好的系统监控工具）
sudo apt install -y htop

# 使用 htop 查看系统资源
htop

# 或使用 top
top

# 查看内存使用
free -h

# 查看磁盘使用
df -h
```

### 4. 设置自动备份

#### 数据库备份脚本

```bash
# 创建备份目录
sudo mkdir -p /opt/backups

# 创建备份脚本
sudo nano /opt/backup_db.sh
```

在编辑器中输入以下内容：

```bash
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 从 .env 文件读取数据库密码（需要先安装 jq）
# 或者直接在脚本中设置密码变量
DB_PASSWORD="ddac#afJDWX_BACKEND_USER01%3"

mysqldump -u jdwx_backend_user01 -p${DB_PASSWORD} jdwx_db > $BACKUP_DIR/jdwx_db_${DATE}.sql

# 压缩备份文件
gzip $BACKUP_DIR/jdwx_db_${DATE}.sql

# 保留最近7天的备份
find $BACKUP_DIR -name "jdwx_db_*.sql.gz" -mtime +7 -delete

echo "备份完成: jdwx_db_${DATE}.sql.gz"
```

```bash
# 设置执行权限
sudo chmod +x /opt/backup_db.sh

# 测试备份脚本
sudo /opt/backup_db.sh
```

#### 设置定时任务（Crontab）

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每天凌晨2点执行备份）
0 2 * * * /opt/backup_db.sh >> /opt/backups/backup.log 2>&1
```

#### 文件备份

```bash
# 备份上传的文件
sudo tar -czf /opt/backups/uploads_$(date +%Y%m%d).tar.gz /opt/jdwx_backend_server/uploads

# 也可以添加到 crontab
# 0 3 * * * tar -czf /opt/backups/uploads_$(date +\%Y\%m\%d).tar.gz /opt/jdwx_backend_server/uploads
```

## 故障排查

### 1. 服务无法启动

```bash
# 检查 PM2 日志
pm2 logs jdwx-backend --err

# 检查 Systemd 日志
sudo journalctl -u jdwx-backend.service -n 50

# 检查环境变量
cd /opt/jdwx_backend_server
node -e "require('dotenv').config(); console.log(process.env.DB_HOST)"

# 手动测试启动
cd /opt/jdwx_backend_server
NODE_ENV=production node src/server.js
```

### 2. 数据库连接失败

```bash
# 测试数据库连接
mysql -u jdwx_backend_user01 -p -h localhost jdwx_db

# 检查 MySQL 服务状态
sudo systemctl status mysql

# 检查 MySQL 是否运行
sudo systemctl start mysql

# 检查防火墙
sudo ufw status

# 检查 MySQL 端口
sudo netstat -tlnp | grep 3306
```

### 3. 端口被占用

```bash
# 查找占用 3000 端口的进程
sudo lsof -i :3000
# 或
sudo netstat -tlnp | grep 3000

# 如果端口被占用，可以：
# 1. 停止占用端口的进程
# 2. 或修改 .env 中的 PORT 为其他端口（如 3001）
```

### 4. 文件上传失败

```bash
# 检查上传目录权限
ls -la /opt/jdwx_backend_server/uploads

# 修复权限
sudo chmod 775 /opt/jdwx_backend_server/uploads
sudo chown -R www-data:www-data /opt/jdwx_backend_server/uploads

# 检查磁盘空间
df -h

# 检查 Nginx 配置中的 client_max_body_size
sudo grep client_max_body_size /etc/nginx/sites-available/jdwx-backend
```

### 5. Nginx 502 Bad Gateway

```bash
# 检查后端服务是否运行
pm2 status
curl http://localhost:3000/api/health

# 检查 Nginx 错误日志
sudo tail -f /var/log/nginx/jdwx-backend-error.log

# 检查 Nginx 配置
sudo nginx -t
```

### 6. 性能问题

```bash
# 检查内存使用
free -h
pm2 monit

# 检查 CPU 使用
top
htop

# 检查 Node.js 进程
ps aux | grep node

# 检查数据库连接
mysql -u jdwx_backend_user01 -p -e "SHOW PROCESSLIST;" jdwx_db
```

## 常用命令

### 服务管理

```bash
# 重启服务（PM2）
pm2 restart jdwx-backend

# 重启服务（Systemd）
sudo systemctl restart jdwx-backend.service

# 停止服务
pm2 stop jdwx-backend
# 或
sudo systemctl stop jdwx-backend.service

# 启动服务
pm2 start jdwx-backend
# 或
sudo systemctl start jdwx-backend.service

# 查看服务状态
pm2 status
# 或
sudo systemctl status jdwx-backend.service

# 重新加载配置（不中断服务）
pm2 reload jdwx-backend
```

### 日志查看

```bash
# PM2 日志
pm2 logs jdwx-backend

# Systemd 日志
sudo journalctl -u jdwx-backend.service -f

# 应用日志
tail -f /opt/jdwx_backend_server/logs/*.log
```

### Nginx 管理

```bash
# 重新加载配置
sudo systemctl reload nginx

# 重启 Nginx
sudo systemctl restart nginx

# 检查配置
sudo nginx -t

# 查看状态
sudo systemctl status nginx
```

## 更新部署

当需要更新代码时：

```bash
# 1. 备份当前版本
cd /opt/jdwx_backend_server
sudo cp -r . ../jdwx_backend_server_backup_$(date +%Y%m%d)

# 2. 拉取最新代码（如果使用 Git）
git pull

# 或重新上传文件

# 3. 安装新依赖
npm install --production

# 4. 重启服务
pm2 restart jdwx-backend
# 或
sudo systemctl restart jdwx-backend.service

# 5. 检查服务状态
pm2 status
curl http://localhost:3000/api/health
```

## 快速检查清单

部署完成后，请确认以下项目：

- [ ] Node.js 已安装并版本正确
- [ ] MySQL 已安装并运行
- [ ] Nginx 已安装并运行
- [ ] PM2 已安装并配置开机自启
- [ ] 项目文件已上传到 `/opt/jdwx_backend_server`
- [ ] `.env` 文件已配置且密码正确
- [ ] 数据库和用户已创建
- [ ] 服务可以正常启动
- [ ] 健康检查接口返回正常
- [ ] Nginx 配置正确且可以访问
- [ ] 防火墙已配置
- [ ] 文件权限已设置正确
- [ ] 备份脚本已配置

## API 接口说明

### 基础信息

- **API 前缀**: `/api`
- **认证方式**: JWT Token（Bearer Token）
- **请求头**: `Authorization: Bearer <token>`

### 健康检查

- **GET** `/api/health`
- **描述**: 检查服务状态和数据库连接
- **响应示例**:
```json
{
  "success": true,
  "uptime": 123.456,
  "timestamp": "2024-12-20T10:00:00.000Z",
  "database": "connected"
}
```

### 认证接口

#### 注册

- **POST** `/api/register`
- **请求体**:
```json
{
  "username": "string (至少2位)",
  "password": "string (至少9位)",
  "phone": "string (可选)",
  "role": "user (默认)"
}
```
- **响应**:
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "testuser",
    "role": "user",
    "phone": "13800138000",
    "created_at": "2024-12-20T10:00:00.000Z"
  },
  "token": "jwt_token_string"
}
```

#### 登录

- **POST** `/api/login`
- **请求体**:
```json
{
  "username": "string",
  "password": "string"
}
```
- **响应**:
```json
{
  "success": true,
  "message": "登录成功",
  "token": "jwt_token_string",
  "user": {
    "id": 1,
    "username": "testuser",
    "role": "user",
    "phone": "13800138000",
    "created_at": "2024-12-20T10:00:00.000Z"
  }
}
```

### 订单接口

#### 提交订单（用户）

- **POST** `/api/orders`
- **权限**: 需要登录，角色为 `user`
- **请求体**:
```json
{
  "location": "string",
  "phone": "string",
  "description": "string",
  "image_url": "string (可选)"
}
```

#### 获取订单列表（员工）

- **GET** `/api/orders?status=pending&page=1&pageSize=20`
- **权限**: 需要登录，角色为 `staff`
- **查询参数**: `status` (可选), `page` (默认1), `pageSize` (默认20)

#### 获取我的订单（用户）

- **GET** `/api/orders/my?page=1&pageSize=20`
- **权限**: 需要登录，角色为 `user`
- **查询参数**: `page` (默认1), `pageSize` (默认20)

#### 接单（员工）

- **POST** `/api/orders/:id/take`
- **权限**: 需要登录，角色为 `staff`

#### 完成订单（员工）

- **POST** `/api/orders/:id/finish`
- **权限**: 需要登录，角色为 `staff`
- **请求体**:
```json
{
  "message": "string (可选)"
}
```

#### 取消订单（用户）

- **POST** `/api/orders/:id/cancel`
- **权限**: 需要登录，角色为 `user`，仅创建者可取消

#### 修改订单信息（用户）

- **PATCH** `/api/orders/:id`
- **权限**: 需要登录，角色为 `user`，仅创建者可修改
- **请求体**:
```json
{
  "location": "string (可选)",
  "phone": "string (可选)",
  "description": "string (可选)"
}
```

#### 评价订单（用户）

- **POST** `/api/orders/:id/rate`
- **权限**: 需要登录，角色为 `user`，仅创建者可评价，订单状态需为 `done`
- **请求体**:
```json
{
  "rating": 1-5,
  "rating_comment": "string (可选)"
}
```

#### 获取订单详情

- **GET** `/api/orders/:id`
- **权限**: 需要登录，用户只能查看自己的订单

#### 获取订单日志（员工）

- **GET** `/api/orders/:id/logs`
- **权限**: 需要登录，角色为 `staff`

### 文件上传接口

#### 上传文件

- **POST** `/api/upload`
- **权限**: 需要登录
- **请求**: `multipart/form-data`，字段名 `file`
- **支持格式**: image/jpeg, image/png, image/gif, image/webp, image/bmp, image/jpg
- **响应**:
```json
{
  "success": true,
  "url": "http://your-domain.com/uploads/filename.jpg"
}
```

### 订单状态说明

- `pending`: 待处理
- `doing`: 处理中
- `done`: 已完成
- `cancelled`: 已取消

## 联系支持

如遇到问题，请检查：

1. **日志文件**：查看 PM2、Systemd、应用和 Nginx 日志
2. **环境变量**：确认 `.env` 文件配置正确
3. **数据库连接**：测试数据库连接和权限
4. **网络和防火墙**：检查端口和防火墙设置
5. **服务状态**：确认所有相关服务都在运行

---

**文档版本**: v1.0  
**适用系统**: Ubuntu 20.04+ / 全新系统  
**最后更新**: 2024-12-20
